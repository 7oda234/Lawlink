name: LawLink CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build, Lint, and Secure
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      statuses: write
      pull-requests: write
      issues: write

    steps:
      # 1. Setup Environment
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for Super-Linter

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # Automates dependency caching

      # 2. Optimization & Cache
      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13
        with:
          use-gha-cache: true

      # 3. Security & Dependency Review
      - name: Dependency Review
        uses: actions/dependency-review-action@v4.8.2
        with:
          fail-on-severity: high

      - name: Official SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v7.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} # Must be set in GitHub Secrets

      # 4. Linting & Formatting
      - name: Super-Linter
        uses: super-linter/super-linter@v8.4.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false # Only lint new changes for speed

      - name: Prettier Action
        uses: creyD/prettier_action@v4.6
        with:
          prettier_options: --write **/*.{js,jsx,css,md}
          same_commit: true # Keeps your git history clean

      # 5. Build & Test
      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm test
